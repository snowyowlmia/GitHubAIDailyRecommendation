name: Debug AI GitHub Tracker

on:
  workflow_dispatch:  # 只支持手动触发

permissions:
  contents: write  # 允许修改仓库内容
  actions: read    # 允许读取Actions

jobs:
  debug_track_ai_projects:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check environment and configuration
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "🔍 环境检查:"
        echo "Python版本: $(python --version)"
        echo "GH_TOKEN设置: $([[ -n "$GH_TOKEN" ]] && echo '✅ 已设置' || echo '❌ 未设置')"
        echo "DISCORD_WEBHOOK_URL设置: $([[ -n "$DISCORD_WEBHOOK_URL" ]] && echo '✅ 已设置' || echo '⚠️ 未设置')"
        echo ""
        echo "📂 文件检查:"
        ls -la
        echo ""
        echo "📊 当前统计:"
        python ai_tracker.py --stats || echo "无统计数据"

    - name: Reset and run tracker (debug mode)
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "🔄 重置推送记录以确保有内容推送..."
        python ai_tracker.py --reset
        echo ""
        echo "🚀 运行AI追踪器（调试模式）..."
        python ai_tracker.py 2>&1 | tee tracker_output.log
        echo ""
        echo "📈 运行后统计:"
        python ai_tracker.py --stats

    - name: Test different timeframes
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "📊 测试30天趋势..."
        python ai_tracker.py --trend-timeframe 30days || echo "30天趋势测试失败"
        echo ""
        echo "🚀 测试7天趋势..."
        python ai_tracker.py --trend-timeframe 7days || echo "7天趋势测试失败"

    - name: Show detailed output
      run: |
        echo "📋 详细输出日志:"
        if [ -f tracker_output.log ]; then
          cat tracker_output.log
        else
          echo "无日志文件"
        fi
        echo ""
        echo "📁 最终文件状态:"
        ls -la
        if [ -f sent_projects.json ]; then
          echo "sent_projects.json 内容:"
          head -20 sent_projects.json
        fi

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Debug"
        git add sent_projects.json
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Debug run - Update sent projects - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        fi