name: AI GitHub Daily Tracker

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ7ç‚¹æ‰§è¡Œ (UTCæ—¶é—´å‰ä¸€å¤©23ç‚¹)
    - cron: '0 23 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸ä¿®æ”¹ä»“åº“å†…å®¹
  actions: read    # å…è®¸è¯»å–Actions

jobs:
  track_ai_projects:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN || secrets.PUSH_TOKEN || github.token }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check environment
      run: |
        echo "ğŸ” æ£€æŸ¥ç¯å¢ƒé…ç½®..."
        echo "Pythonç‰ˆæœ¬: $(python --version)"
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date)"
        echo "UTCæ—¶é—´: $(date -u)"
        echo "æ£€æŸ¥ai_tracker.pyæ˜¯å¦å­˜åœ¨:"
        if [ -f ai_tracker.py ]; then
          echo "âœ… ai_tracker.py å­˜åœ¨"
        else
          echo "âŒ ai_tracker.py ä¸å­˜åœ¨"
          exit 1
        fi

    - name: Environment check
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "ğŸ”§ ç¯å¢ƒå˜é‡æ£€æŸ¥:"
        echo "GH_TOKEN: $([[ -n "$GH_TOKEN" ]] && echo 'âœ… å·²è®¾ç½®' || echo 'âŒ æœªè®¾ç½®')"
        echo "DISCORD_WEBHOOK_URL: $([[ -n "$DISCORD_WEBHOOK_URL" ]] && echo 'âœ… å·²è®¾ç½®' || echo 'âš ï¸ æœªè®¾ç½®')"
        echo ""
        echo "ğŸ§ª æµ‹è¯•å‘½ä»¤è¡Œå‚æ•°..."
        python ai_tracker.py --help || echo "âŒ å‘½ä»¤è¡Œå‚æ•°æµ‹è¯•å¤±è´¥"

    # æ™®é€šAIé¡¹ç›®æ¨é€åºåˆ—
    - name: "1ï¸âƒ£ æ™®é€šAI - Lifetimeè¶‹åŠ¿"
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "ğŸ¤– æ¨é€æ™®é€šAIé¡¹ç›® - Lifetimeè¶‹åŠ¿..."
        python ai_tracker.py --trend-timeframe lifetime
        sleep 30  # é¿å…APIé™åˆ¶å’ŒDiscordæ¶ˆæ¯è¿‡å¿«

    - name: "2ï¸âƒ£ æ™®é€šAI - 30å¤©è¶‹åŠ¿"
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "ğŸ“ˆ æ¨é€æ™®é€šAIé¡¹ç›® - 30å¤©è¶‹åŠ¿..."
        python ai_tracker.py --trend-timeframe 30days
        sleep 30

    - name: "3ï¸âƒ£ æ™®é€šAI - 7å¤©è¶‹åŠ¿"
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "ğŸš€ æ¨é€æ™®é€šAIé¡¹ç›® - 7å¤©è¶‹åŠ¿..."
        python ai_tracker.py --trend-timeframe 7days
        sleep 30

    # å•†ç”¨AIé¡¹ç›®æ¨é€åºåˆ—
    - name: "4ï¸âƒ£ å•†ç”¨AI - Lifetimeè¶‹åŠ¿"
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "ğŸ’¼ æ¨é€å•†ç”¨AIé¡¹ç›® - Lifetimeè¶‹åŠ¿..."
        python ai_tracker.py --commercial --trend-timeframe lifetime
        sleep 30

    - name: "5ï¸âƒ£ å•†ç”¨AI - 30å¤©è¶‹åŠ¿"
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "ğŸ’° æ¨é€å•†ç”¨AIé¡¹ç›® - 30å¤©è¶‹åŠ¿..."
        python ai_tracker.py --commercial --trend-timeframe 30days
        sleep 30

    - name: "6ï¸âƒ£ å•†ç”¨AI - 7å¤©è¶‹åŠ¿"
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "ğŸ¯ æ¨é€å•†ç”¨AIé¡¹ç›® - 7å¤©è¶‹åŠ¿..."
        python ai_tracker.py --commercial --trend-timeframe 7days
        sleep 30

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add sent_projects.json
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update sent projects - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        fi