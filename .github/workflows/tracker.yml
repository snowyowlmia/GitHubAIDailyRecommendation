name: AI GitHub Daily Tracker

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹æ‰§è¡Œ (UTCæ—¶é—´1ç‚¹)
    - cron: '0 1 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸ä¿®æ”¹ä»“åº“å†…å®¹
  actions: read    # å…è®¸è¯»å–Actions

jobs:
  track_ai_projects:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PUSH_TOKEN || github.token }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check environment
      run: |
        echo "ğŸ” æ£€æŸ¥ç¯å¢ƒé…ç½®..."
        echo "Pythonç‰ˆæœ¬: $(python --version)"
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo "æ£€æŸ¥ai_tracker.pyæ˜¯å¦å­˜åœ¨:"
        if [ -f ai_tracker.py ]; then
          echo "âœ… ai_tracker.py å­˜åœ¨"
        else
          echo "âŒ ai_tracker.py ä¸å­˜åœ¨"
          exit 1
        fi

    - name: Test AI tracker help
      run: |
        echo "ğŸ§ª æµ‹è¯•å‘½ä»¤è¡Œå‚æ•°..."
        python ai_tracker.py --help || echo "âŒ å‘½ä»¤è¡Œå‚æ•°æµ‹è¯•å¤±è´¥"

    - name: Run AI tracker
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        echo "ğŸš€ å¼€å§‹è¿è¡ŒAIè¿½è¸ªå™¨..."
        echo "ç¯å¢ƒå˜é‡æ£€æŸ¥:"
        echo "GH_TOKEN: $([[ -n "$GH_TOKEN" ]] && echo 'âœ… å·²è®¾ç½®' || echo 'âŒ æœªè®¾ç½®')"
        echo "DISCORD_WEBHOOK_URL: $([[ -n "$DISCORD_WEBHOOK_URL" ]] && echo 'âœ… å·²è®¾ç½®' || echo 'âš ï¸ æœªè®¾ç½®')"
        echo ""
        python ai_tracker.py

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add sent_projects.json
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update sent projects - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        fi